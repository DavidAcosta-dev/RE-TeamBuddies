# TbActorState Layout Sketch

Generated: 2025-09-25

## Goal

Correlate the Team Buddies actor state structure populated by `FUN_00032c18` with the Wipeout PSX `ShipData` layout. This pass focuses on the offset band `0x128`–`0x190`, where the initializer mirrors many of Wipeout's per-ship attributes (orientation vectors, physics constants, and throttle tuning).

## Prefix Offsets (0x00–0x127) Clues

We have now formalized the front of `TbActorState` as `TbActorPrefix` in `datatypes/tb_types.h`. Several high-scoring integrator routines reveal consistent usage patterns that match the chosen field names. See also the autogenerated evidence table in `exports/actor_prefix_confirmation.md`.

- `FUN_00044f80` writes normalized orientation basis vectors into shorts at `actor+0x34`, `0x36`, and `0x38`, and consumes source components from `actor+0x3C`, `0x3E`, `0x40`. These match the Wipeout `unitVecWing` and `unitVecNose` update sequence, suggesting the prefix holds a packed SVECTOR pair preceding the config block.
- `FUN_00044a14` calculates dot products using the same offsets (`+0x34`, `+0x3E`, `+0x40`) and compares the result with `*(short*)(actor+0x44)`, reinforcing that `+0x44` stores the current forward speed magnitude (Wipeout’s `speed`).
- The magnet integrator in `FUN_00022e5c` performs direct position updates via `*(ushort*)(actor+0x08)` and `*(ushort*)(actor+0x0C)`, aligning with the `TbPhysicsState.position` comments that place the world position vector beginning at offset `0x08`.
- `FUN_0001e750` references `actor+0x26` as a flag field before applying damping—consistent with `TbPhysicsState.flags`.

Working hypothesis (supported by counts in `actor_prefix_confirmation.md`):

| Offset | Observations | Proposed Field | Wipeout Reference |
| --- | --- | --- | --- |
| 0x08–0x10 | Position reads/writes in integrators (`FUN_00022e5c`, `FUN_0001e750`) | `TbVec3Q12 position` | `ShipData.ppivot` |
| 0x20–0x24 | Angle inputs to trig helpers (`FUN_00044f80` caller) | `yaw`, `pitch`, `roll` | `ShipData.hdg/pitch/roll` |
| 0x26 | Flag checks before magnet logic | `flags` | `ShipData.attr` bit subset |
| 0x34–0x3A | Basis vector overwritten in `FUN_00044f80` | `basis_fwd_*` (+ optional len) | `unitVecNose` / `unitVecWing` |
| 0x3C–0x40 | Source basis components (pre-normalization) | `basis_source` | `vpivot` or cached thrust axis |
| 0x44 | Speed magnitude clamped in `FUN_00044a14` | `speed` | `ShipData.speed` |

Next actions:

1. Confirm whether offsets `0x3C`–`0x40` map to `TbActorConfigBlock.thrust` or to a transient basis buffer by tracing callers of `FUN_00044a14`. Current evidence shows strong usage in `FUN_00044a14`/`FUN_00044f80`.
2. Identify which routines write to `actor+0x26` to establish a definitive flag enum (counts show multiple checks in control code; still untyped).
3. Done: Replaced the placeholder with `TbActorPrefix`. Continue refining comments and types as we validate additional offsets.

## Evidence Source

- `FUN_00032c18` (0x032c18) fills a contiguous block beginning at `actor + 0x128`. The function reads a parameter table (`param_2`) that matches the Wipeout `ConfigData` template. Shifts by `>> 6` and `>> 0xC` line up with the Wipeout convention of storing angles in quarter-degree ticks and Q12 fixed-point for magnitudes.
- Wipeout `ShipData` (`assets/WIPESRC/Wipeout PSX/SHIPS.H`) defines analogous fields: `unitVecNose`, `unitVecWing`, `thrust`, `resistance`, `skid`, etc. The ordering (orientation vectors → thrust constants → brake limits) maps cleanly onto the write sequence in 0x032c18.

## Offset Map (Provisional)

| Offset | `FUN_00032c18` Write | Proposed TB Field | Wipeout Analogue | Notes |
| --- | --- | --- | --- | --- |
| 0x128 | `*(u32*)(actor+0x128) = config[0]; type = (s16)` same slot | `actorType` | `attr` / ship config slot | Signed short gating heavy actor cases at +0x174; values 4, 7, 0x0B mirror Wipeout AI categories. |
| 0x12C | `*(u32*)(actor+0x12C) = paramId` | `actorId` | `shipNo` index | Stores masked actor identifier (`param_1 & 0x0FFF`). |
| 0x130 | `actor+0x130 = config[0x25]` | `scriptPtr` | `updateControl` seed | Pointer-like payload consumed by the control pipeline. |
| 0x134 | `actor+0x134 = func_743a4(1, actorId)` | `trackSectionPtr` | `nearTrkSect` | Loader returning a track-section pointer; matches `ShipData.nearTrkSect`. |
| 0x138–0x13E | `config[4..7] >> 6` | `unitForward` | `unitVecNose` | /64 scaling equals Wipeout SVECTOR packing; later division by config[7] normalizes length. |
| 0x140 | `config[8] >> 0xC` | `heightTarget` | `TARGETHEIGHT` | Q12 vertical target reused at +0x152. |
| 0x142 | `(-config[9]) >> 6` | `rollBias` | `vroll` | Negated /64 roll velocity consistent with Wipeout convention. |
| 0x144 | `config[10] >> 0xC` | `velocityForward` | `vpivot.z` | Q12 forward velocity. |
| 0x146 | `config[11] >> 0xC` | `velocityUp` | `vpivot.y` | Q12 vertical velocity. |
| 0x148 | `config[13]` | `mass` | `mass` | Raw short; heavy actors triple value when `actorType` equals 4 or 0x0B. |
| 0x14A | `config[14]` | `dragPad` | `headingInc` / brake tuning | Auxiliary steering parameter; classification pending. |
| 0x14C | `config[16]` | `maxThrust` | `max_thrust` | Matches Wipeout thrust cap ordering. |
| 0x14E | `config[0x12] >> 6` | `turnRate` | `headingInc` | /64 scaling equals heading increment units. |
| 0x150 | `config[0x17]` | `brakeRotLeft` | `l_brake_rot` | Left air-brake rotation limit. |
| 0x152 | `(heightTarget * 0x477) / config[7]` | `heightToForwardRatio` | `TRACK_MAGNET` scaler | Derived magnet strength matching grounded integrator math. |
| 0x154 | `config[0x18]` | `thrustMag` | `thrust_mag` | Baseline thrust magnitude. |
| 0x156 | `(config[0x18] * config[0x1B]) >> 0xC` | `thrustBoost` | `thrust` boost | Q12 product used for turbo / weapon boosts. |
| 0x158 | `config[0x1A]` | `remoteThrustMag` | `remoteThrustMag` | Remote throttle magnitude. |
| 0x15A | `config[0x19]` | `remoteFightBack` | `fightBack` | AI aggression constant. |
| 0x15C | `config[0x1C]` | `remoteMaxThrust` | `remoteMaxThrust` | Cap for remote throttle. |
| 0x15E | `config[0x16]` | `brakeRotRight` | `r_brake_rot` | Right air-brake rotation limit. |
| 0x160 | `config[0x1D] >> 0xC` | `resistance_q12` | `resistance` | Q12 drag constant (ties into integrator config). |
| 0x162 | `config[0x21]` | `rescueTimer` | `rescue` timer | Countdown driving rescue droid logic. |
| 0x164 | `config[0x1F] >> 0xC` | `skid_friction_q12` | `skid` | Q12 sideways friction constant. |
| 0x166 | `config[0x22]` | `combatAttr` | `combatAttr` | Combat bitfield. |
| 0x168 | `config[0x1E] >> 0xC` | `mass_q12` | `mass` (Q12) | Alternate mass / drag scaling; reconcile with raw mass. |
| 0x16A | `config[0x23]` | `weaponType` | `weaponType` | Initial weapon slot. |
| 0x16C | `config[0x20] >> 0xC` | `thrustRamp` | `thrust` ramp factor | Extra Q12 scale controlling throttle ramp. |
| 0x16E | `config[0x24]` | `targetShip` | `targetShip` | Target selection index. |
| 0x170 | `config[0x15] >> 0xC` | `speed_q12` | `speed` | Q12 speed magnitude. |
| 0x172 | `config[0x14] >> 6` with optional ×3 | `maxHeading` | `maxHeading` | Tripled for heavy actors; steering cap. |
| 0x174 | Copy of 0x172 | `maxHeadingCopy` | `maxHeading` mirror | Duplicate field used during control updates. |
| 0x176 | `config[1]` | `lapTimeLow` | `lapTime` low word | Race timer seed (lower word). |
| 0x178 | `config[2]` | `lapTimeHigh` | `lapTime` high word | Race timer seed (upper word). |
| 0x17A | `config[3]` | `lapTimeInit` | `lapTimes[0]` | First lap time entry; mirrored to 0x17C. |
| 0x17C | `config[0x27]` | `updateCount` | `updateCount` | Frame counter for actor updates. |
| 0x180 | Cleared to zero | `weaponCooldown` | `haveFired` flag | Reset before weapon counters increment. |
| 0x184 | `config[0x28]` | `electroCount` | `electroCount` | Weapon status timer. |
| 0x186 | `config[0x29]` | `revConCount` | `revConCount` | Weapon status timer. |
| 0x188 | `config[0x2A]` | `specialCount` | `specialCount` | Weapon status timer. |
| 0x18A | `config[0x26]` | `lapNo` | `lapNo` | Race control attribute. |
| 0x18C | `config[0x2B]` | `rescueFlag` | `rescue` control | Additional rescue parameter. |

## Next Steps

1. **Validate Field Accessors** – Trace callers of `FUN_00044a14`/`FUN_00044f80` to confirm they read the same offsets identified above (especially 0x160/0x164) before we commit these names to headers.
2. **Integrate Struct Stub** – Once key offsets are verified, introduce a `typedef struct TbActorState` in `datatypes/tb_types.h` using the labels above and embed the existing `TbPhysicsState` at the top for positional alignment.
3. **Config Synchronization** – Populate `TbPhysicsIntegratorConfig` defaults from the captured config entries (`resistance_q12`, `skid_friction_q12`, `track_magnet_q12`) to allow script-driven tuning experiments.
4. **Ghidra Tagging** – Annotate 0x032c18/0x044a14/0x044f80 with the proposed field names to reinforce Wipeout parallels and ease future navigation.

> This sketch remains provisional. Revisit after inspecting the MAIN.EXE variants of the integrator (`FUN_0001e750` cluster) to ensure no mismatched offsets between actor types.
